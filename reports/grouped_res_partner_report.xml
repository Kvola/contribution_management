<?xml version="1.0" encoding="utf-8"?>
<odoo>
        <!-- ================= RAPPORT DE SYNTHÈSE PAR GROUPE ================= -->

        <!-- Action pour le rapport de synthèse -->
        <record id="action_report_group_synthesis" model="ir.actions.report">
            <field name="name">Synthèse des cotisations du groupe</field>
            <field name="model">res.partner</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">contribution_management.report_group_synthesis_template</field>
            <field name="report_file">contribution_management.report_group_synthesis_template</field>
            <field name="binding_model_id" ref="base.model_res_partner" />
            <field name="binding_type">report</field>
        </record>

        <!-- Template du rapport de synthèse -->
        <template id="report_group_synthesis_template">
            <t t-call="web.html_container">
                <t t-foreach="docs.filtered(lambda p: p.is_company)" t-as="group">
                    <t t-call="web.external_layout">
                        <div class="page">
                            <div class="oe_structure" />

                            <!-- En-tête du rapport -->
                            <div class="row">
                                <div class="col-12">
                                    <h2 class="text-center">
                                        <strong>SYNTHÈSE DES COTISATIONS</strong>
                                    </h2>
                                    <h3 class="text-center text-muted">
                                        <span t-field="group.name" />
                                    </h3>
                                    <p class="text-center text-muted"> Rapport généré le <span
                                            t-esc="context_timestamp(datetime.datetime.now()).strftime('%d/%m/%Y à %H:%M')" />
                                    </p>
                                </div>
                            </div>

                            <!-- Informations du groupe -->
                            <div class="row mt-4">
                                <div class="col-6">
                                    <strong>Type:</strong> Groupe/Organisation </div>
                                <div class="col-6">
                                    <strong>Email:</strong>
                                    <span t-field="group.email" />
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <strong>Téléphone:</strong>
                                    <span t-field="group.phone" />
                                </div>
                                <div class="col-6">
                                    <strong>Devise:</strong>
                                    <span t-field="group.currency_id.name" />
                                </div>
                            </div>

                            <!-- Statistiques générales -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h4>Statistiques générales</h4>
                                    <div class="row">
                                        <div class="col-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="card-title"
                                                        t-esc="group.activities_count" />
                                                    <p class="card-text">Activités</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="card-title"
                                                        t-esc="group.monthly_cotisations_count" />
                                                    <p class="card-text">Cotisations mensuelles</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="card-title"
                                                        t-esc="group.group_total_collected"
                                                        t-options="{'widget': 'monetary', 'display_currency': group.currency_id}" />
                                                    <p class="card-text">Total collecté</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="card-title"
                                                        t-esc="'%.1f%%' % group.group_collection_rate" />
                                                    <p class="card-text">Taux de collecte</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Activités du groupe -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h4>Activités récentes</h4>
                                    <t t-if="group.group_activities">
                                        <table class="table table-sm table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Activité</th>
                                                    <th>Date début</th>
                                                    <th>Date fin</th>
                                                    <th>Total collecté</th>
                                                    <th>Total attendu</th>
                                                    <th>Taux de collecte</th>
                                                    <th>État</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t
                                                    t-foreach="group.group_activities.filtered('active').sorted(key=lambda a: a.create_date, reverse=True)[:10]"
                                                    t-as="activity">
                                                    <tr>
                                                        <td>
                                                            <span t-field="activity.name" />
                                                        </td>
                                                        <td>
                                                            <span t-field="activity.date_start"
                                                                t-options="{'widget': 'date'}" />
                                                        </td>
                                                        <td>
                                                            <span t-field="activity.date_end"
                                                                t-options="{'widget': 'date'}" />
                                                        </td>
                                                        <td>
                                                            <span t-field="activity.total_collected"
                                                                t-options="{'widget': 'monetary', 'display_currency': activity.currency_id}" />
                                                        </td>
                                                        <td>
                                                            <span t-field="activity.total_expected"
                                                                t-options="{'widget': 'monetary', 'display_currency': activity.currency_id}" />
                                                        </td>
                                                        <td>
                                                            <span t-if="activity.total_expected > 0"
                                                                t-esc="'%.1f%%' % ((activity.total_collected / activity.total_expected) * 100)" />
                                                            <span t-else="">N/A</span>
                                                        </td>
                                                        <td>
                                                            <span class="badge"
                                                                t-attf-class="badge-{{ 'success' if activity.state == 'completed' else 'warning' if activity.state == 'in_progress' else 'secondary' }}">
                                                                <span t-field="activity.state" />
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </t>
                                    <t t-else="">
                                        <div class="alert alert-info">
                                            <i class="fa fa-info-circle" /> Aucune activité
                                            enregistrée pour ce groupe. </div>
                                    </t>
                                </div>
                            </div>

                            <!-- Cotisations mensuelles -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h4>Cotisations mensuelles récentes</h4>
                                    <t t-if="group.monthly_cotisations">
                                        <table class="table table-sm table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Période</th>
                                                    <th>Montant unitaire</th>
                                                    <th>Total collecté</th>
                                                    <th>Total attendu</th>
                                                    <th>Taux de collecte</th>
                                                    <th>État</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t
                                                    t-foreach="group.monthly_cotisations.filtered('active').sorted(key=lambda m: (m.year, int(m.month) if m.month.isdigit() else 0), reverse=True)[:12]"
                                                    t-as="monthly">
                                                    <tr>
                                                        <td>
                                                            <span t-field="monthly.display_name" />
                                                        </td>
                                                        <td>
                                                            <span t-field="monthly.amount"
                                                                t-options="{'widget': 'monetary', 'display_currency': monthly.currency_id}" />
                                                        </td>
                                                        <td>
                                                            <span t-field="monthly.total_collected"
                                                                t-options="{'widget': 'monetary', 'display_currency': monthly.currency_id}" />
                                                        </td>
                                                        <td>
                                                            <span t-field="monthly.total_expected"
                                                                t-options="{'widget': 'monetary', 'display_currency': monthly.currency_id}" />
                                                        </td>
                                                        <td>
                                                            <span t-if="monthly.total_expected > 0"
                                                                t-esc="'%.1f%%' % ((monthly.total_collected / monthly.total_expected) * 100)" />
                                                            <span t-else="">N/A</span>
                                                        </td>
                                                        <td>
                                                            <span class="badge"
                                                                t-attf-class="badge-{{ 'success' if monthly.state == 'completed' else 'warning' if monthly.state == 'in_progress' else 'secondary' }}">
                                                                <span t-field="monthly.state" />
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </t>
                                    <t t-else="">
                                        <div class="alert alert-info">
                                            <i class="fa fa-info-circle" /> Aucune cotisation
                                            mensuelle enregistrée pour ce groupe. </div>
                                    </t>
                                </div>
                            </div>

                            <!-- Résumé financier -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h4>Résumé financier</h4>
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-4">
                                                    <p>
                                                        <strong>Total collecté:</strong>
                                                    </p>
                                                    <h5 class="text-success"
                                                        t-esc="group.group_total_collected"
                                                        t-options="{'widget': 'monetary', 'display_currency': group.currency_id}" />
                                                </div>
                                                <div class="col-4">
                                                    <p>
                                                        <strong>Total attendu:</strong>
                                                    </p>
                                                    <h5 class="text-primary"
                                                        t-esc="group.group_total_expected"
                                                        t-options="{'widget': 'monetary', 'display_currency': group.currency_id}" />
                                                </div>
                                                <div class="col-4">
                                                    <p>
                                                        <strong>Taux de collecte global:</strong>
                                                    </p>
                                                    <h5
                                                        t-attf-class="text-{{ 'success' if group.group_collection_rate >= 80 else 'warning' if group.group_collection_rate >= 50 else 'danger' }}"
                                                        t-esc="'%.1f%%' % group.group_collection_rate" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="oe_structure" />
                        </div>
                    </t>
                </t>
            </t>
        </template>
</odoo>